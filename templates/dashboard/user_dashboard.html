{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FronteraTech - Dashboard</title>
    <link rel="icon" type="image/png" href="{% static 'images/frontera-logo-hex.png' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        /* Estilos básicos */
        body {
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, sans-serif;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Tarjetas de estadísticas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 1.25rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
            position: relative;
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: clamp(1.25rem, 2.5vw, 1.75rem);
            font-weight: 600;
            margin: 0 2rem 0 0;
            color: #333;
            line-height: 1.2;
        }

        .stat-card p {
            color: #6c757d;
            margin: 0;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .stat-card .icon {
            font-size: 2rem;
            opacity: 0.2;
            position: absolute;
            right: 1rem;
            top: 1rem;
        }

        /* Secciones */
        .section-card {
            background: white;
            border-radius: 8px;
            padding: clamp(1rem, 3vw, 1.5rem);
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
            border: 1px solid #e9ecef;
        }

        .section-title {
            font-size: clamp(1rem, 2vw, 1.125rem);
            font-weight: 600;
            margin-bottom: 1rem;
            color: #333;
        }

        /* Estados de Celery */
        .celery-status {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .celery-status.healthy {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .celery-status.unhealthy {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Indicadores de procesamiento */
        .processing-indicator {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.25rem 0.5rem;
            background: #e7f3ff;
            color: #0d6efd;
            border-radius: 4px;
            font-size: 0.75rem;
            animation: pulse-blue 2s infinite;
        }

        @keyframes pulse-blue {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .processing-indicator i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Badges de estado */
        .badge-status {
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .badge-pending { background: #fff3cd; color: #856404; }
        .badge-approved { background: #d4edda; color: #155724; }
        .badge-rejected { background: #f8d7da; color: #721c24; }
        .badge-processing { background: #e7f3ff; color: #0d6efd; }

        /* Barras de progreso */
        .progress-tracker {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 1rem;
            margin: 0.5rem 0;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            position: relative;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            flex: 1;
            position: relative;
        }

        .progress-step-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
            border: 2px solid #dee2e6;
            background: white;
            color: #6c757d;
        }

        .progress-step.completed .progress-step-circle {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .progress-step.active .progress-step-circle {
            background: #0d6efd;
            color: white;
            border-color: #0d6efd;
            animation: pulse-blue 1.5s infinite;
        }

        .progress-step.failed .progress-step-circle {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .progress-step-label {
            font-size: 0.7rem;
            color: #6c757d;
            text-align: center;
            max-width: 80px;
        }

        .progress-step.completed .progress-step-label {
            color: #28a745;
            font-weight: 500;
        }

        .progress-step.active .progress-step-label {
            color: #0d6efd;
            font-weight: 500;
        }

        /* Botones de procesamiento */
        .process-btn {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            border: 1px solid;
            background: transparent;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 70px;
            text-align: center;
        }

        .process-btn.start {
            border-color: #28a745;
            color: #28a745;
        }

        .process-btn.start:hover {
            background: #28a745;
            color: white;
        }

        .process-btn.stop {
            border-color: #dc3545;
            color: #dc3545;
        }

        .process-btn.stop:hover {
            background: #dc3545;
            color: white;
        }

        /* Lista de tareas */
        .task-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background: #f8f9fa;
        }

        .task-item {
            padding: 0.75rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-item:last-child {
            border-bottom: none;
        }

        .task-details {
            flex: 1;
        }

        .task-id {
            font-family: 'Courier New', monospace;
            font-size: 0.7rem;
            color: #6c757d;
        }

        /* Indicador en vivo */
        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            color: #28a745;
            font-size: 0.75rem;
        }

        .live-indicator::before {
            content: '';
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            animation: pulse-green 1.5s infinite;
        }

        @keyframes pulse-green {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
        }

        /* Tarjeta de Celery */
        .celery-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .celery-card h3 {
            color: white;
            margin-bottom: 0.5rem;
        }

        .celery-card .metric {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        /* Resto de estilos existentes */
        .plan-badge {
            background: #0d6efd;
            color: white;
            padding: 0.375rem 0.75rem;
            border-radius: 4px;
            display: inline-block;
            font-weight: 500;
            font-size: 0.875rem;
            white-space: nowrap;
        }

        .plan-badge.no-plan {
            background: #6c757d;
        }

        .invoice-counter {
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            font-weight: 700;
            color: #333;
            line-height: 1;
        }

        .invoice-counter.danger { color: #dc3545; }
        .invoice-counter.warning { color: #f39c12; }
        .invoice-counter.success { color: #28a745; }

        .progress {
            height: 8px;
            border-radius: 4px;
            background-color: #e9ecef;
            width: 100%;
            overflow: hidden;
        }

        .progress-bar {
            background-color: #0d6efd;
            transition: width 0.3s ease;
        }

        .alert-custom {
            border-radius: 6px;
            border: none;
            padding: 1rem;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
        }

        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
        }

        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .table-custom {
            width: 100%;
            margin-bottom: 1rem;
            border-collapse: collapse;
            min-width: 600px;
        }

        .table-custom th {
            border-top: none;
            font-weight: 600;
            color: #6c757d;
            font-size: 0.875rem;
            text-transform: uppercase;
            padding: 0.75rem;
            border-bottom: 2px solid #e9ecef;
            white-space: nowrap;
        }

        .table-custom td {
            padding: 0.75rem;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }

        .documents-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .documents-filters {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .documents-metrics {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .chart-container {
            position: relative;
            height: 250px;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .token-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 0.75rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            word-break: break-all;
            overflow-wrap: break-word;
        }

        .copy-btn {
            cursor: pointer;
            color: #6c757d;
            transition: color 0.2s;
            padding: 0.25rem;
        }

        .copy-btn:hover {
            color: #0d6efd;
        }

        .plan-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .plan-option {
            padding: 1rem;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .plan-option:hover {
            border-color: #0d6efd;
            background: #f8f9fa;
        }

        .plan-option.selected {
            border-color: #0d6efd;
            background: #e7f3ff;
        }

        .plan-price {
            font-size: clamp(1rem, 3vw, 1.5rem);
            font-weight: 700;
            color: #0d6efd;
        }

        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 300px;
            max-width: 90vw;
        }

        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            padding: 0.5rem 1rem;
        }

        .dropdown-menu {
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .nav-tabs {
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .nav-tabs .nav-link {
            color: #6c757d;
            border: none;
            border-bottom: 2px solid transparent;
            padding: 0.75rem 1rem;
            font-weight: 500;
            white-space: nowrap;
            text-decoration: none;
        }

        .nav-tabs .nav-link.active {
            color: #0d6efd;
            border-bottom-color: #0d6efd;
            background: none;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .metric-card {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            text-align: center;
        }

        .metric-card .value {
            font-size: clamp(1rem, 3vw, 1.5rem);
            font-weight: 700;
            color: #333;
        }

        .metric-card .label {
            font-size: 0.75rem;
            color: #6c757d;
            text-transform: uppercase;
            margin-top: 0.25rem;
        }

        .company-header {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
            box-sizing: border-box;
        }

        .certificate-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        .certificate-status.active {
            background: #d4edda;
            color: #155724;
        }

        .certificate-status.expired {
            background: #f8d7da;
            color: #721c24;
        }

        .certificate-status.missing {
            background: #fff3cd;
            color: #856404;
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .loading-spinner {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0 0.75rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 0.75rem;
            }
            
            .section-card {
                padding: 1rem;
                margin-bottom: 1rem;
            }
            
            .chart-container {
                height: 200px;
            }
            
            .documents-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0 0.5rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .section-card {
                padding: 0.75rem;
                margin-bottom: 0.75rem;
            }
            
            .chart-container {
                height: 150px;
            }
            
            .progress-steps {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold d-none d-lg-block" href="{% url 'core:dashboard' %}">
                <img src="{% static 'images/frontera-logo-full.png' %}" alt="FronteraTech" 
                     style="height: 32px; width: auto; max-width: 200px;">
            </a>
            
            <a class="navbar-brand fw-bold d-none d-md-block d-lg-none" href="{% url 'core:dashboard' %}">
                <img src="{% static 'images/frontera-logo-ft.png' %}" alt="FronteraTech" 
                     style="height: 28px; width: auto;">
            </a>
            
            <a class="navbar-brand fw-bold d-block d-md-none" href="{% url 'core:dashboard' %}">
                <img src="{% static 'images/frontera-logo-hex.png' %}" alt="FT" 
                     style="height: 32px; width: 32px;">
            </a>
            
            <div class="live-indicator d-none d-md-flex">
                <span>En vivo</span>
            </div>
            
            <div class="navbar-nav ms-auto">
                <div class="dropdown">
                    <a class="nav-link dropdown-toggle text-white" href="#" data-bs-toggle="dropdown">
                        <i class="fas fa-user-circle me-1"></i>{{ user.email }}
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="{% url 'account_logout' %}"><i class="fas fa-sign-out-alt me-2"></i>Salir</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-3">
        {% if selected_company %}
            <!-- Company Header -->
            <div class="company-header">
                <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                    <div>
                        <h4 class="mb-0 text-secondary">
                            <i class="fas fa-building me-2"></i>{{ selected_company.business_name|default:selected_company.trade_name }}
                        </h4>
                        {% if selected_company.ruc %}
                            <small class="text-muted">(RUC: {{ selected_company.ruc }})</small>
                        {% endif %}
                        
                        <!-- Estado del certificado -->
                        {% if has_certificate %}
                            {% if certificate_expired %}
                            <span class="certificate-status expired">
                                <i class="fas fa-exclamation-circle"></i>Certificado Expirado
                            </span>
                            {% else %}
                            <span class="certificate-status active">
                                <i class="fas fa-check-circle"></i>Certificado Activo
                            </span>
                            {% endif %}
                        {% else %}
                        <span class="certificate-status missing">
                            <i class="fas fa-times-circle"></i>Sin Certificado
                        </span>
                        {% endif %}
                    </div>
                    
                    <!-- Estado de Celery -->
                    <div class="celery-status" id="headerCeleryStatus">
                        <i class="fas fa-cog fa-spin"></i>
                        <span>Verificando sistema...</span>
                    </div>
                    
                    <!-- Botones de acción -->
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="openEditCompanyModal()">
                            <i class="fas fa-edit me-1"></i>Editar
                        </button>
                        
                        {% if user_companies %}
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                            <div class="dropdown-menu dropdown-menu-end shadow">
                                <h6 class="dropdown-header">Cambiar empresa</h6>
                                {% for company_data in available_companies_with_tokens %}
                                    {% if not company_data.is_selected %}
                                    <a class="dropdown-item" href="{{ company_data.dashboard_url }}">
                                        <i class="fas fa-building me-2 text-muted"></i>
                                        {{ company_data.company.business_name|default:company_data.company.trade_name }}
                                    </a>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Alertas de Billing -->
            <div id="alertContainer">
                {% if billing_available and billing_profile %}
                    {% if billing_profile.available_invoices == 0 %}
                    <div class="alert alert-danger alert-custom mb-4">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-circle fa-2x me-3"></i>
                            <div class="flex-grow-1">
                                <strong>¡Sin documentos disponibles!</strong>
                                <p class="mb-0">Necesitas comprar un plan para poder emitir documentos electrónicos.</p>
                            </div>
                            <a href="#" class="btn btn-danger btn-sm" onclick="activarTabPlanes(); return false;">
                                <i class="fas fa-shopping-cart me-1"></i>Comprar Plan
                            </a>
                        </div>
                    </div>
                    {% elif billing_profile.available_invoices <= 5 %}
                    <div class="alert alert-warning alert-custom mb-4">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                            <div class="flex-grow-1">
                                <strong>Saldo bajo de documentos</strong>
                                <p class="mb-0">Te quedan solo {{ billing_profile.available_invoices }} documentos disponibles.</p>
                            </div>
                            <a href="{% url 'billing:plans_list' %}?company={{ selected_company.id }}" class="btn btn-warning btn-sm">
                                <i class="fas fa-plus-circle me-1"></i>Recargar
                            </a>
                        </div>
                    </div>
                    {% endif %}
                {% endif %}
            </div>

            <!-- Token de la Empresa -->
            {% if selected_company.api_token %}
            <div class="section-card">
                <div class="section-title">
                    <i class="fas fa-key me-2"></i>Token API de la Empresa
                </div>
                <div class="token-display d-flex align-items-center justify-content-between">
                    <span id="companyToken" data-token="{{ selected_company.api_token.key }}">••••••••••••••••••••••••••••••••••••••••</span>
                    <div>
                        <i class="fas fa-eye copy-btn me-2" id="toggleToken" onclick="toggleTokenVisibility()" title="Mostrar/Ocultar token"></i>
                        <i class="fas fa-copy copy-btn" onclick="copyToken()" title="Copiar token"></i>
                    </div>
                </div>
                <div class="mt-2">
                    <small class="text-muted">API Token: {{ selected_company.api_token.name }}</small>
                </div>
                <small class="text-muted">Este token es necesario para utilizar la API REST</small>
            </div>
            {% endif %}

            <!-- Estadísticas -->
            <div class="row mb-4">
                <div class="col-md-3 col-6 mb-3">
                    <div class="stat-card position-relative">
                        <i class="fas fa-file-alt icon"></i>
                        <h3 id="statTotalDocs">{{ stats.total_invoices|default:"0" }}</h3>
                        <p>Total Documentos</p>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="stat-card position-relative">
                        <i class="fas fa-check-circle icon text-success"></i>
                        <h3 id="statAuthorizedDocs">{{ stats.authorized_invoices|default:"0" }}</h3>
                        <p>Autorizados</p>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="stat-card position-relative">
                        <i class="fas fa-dollar-sign icon"></i>
                        <h3 id="statTotalAmount">${{ stats.total_amount|default:"0"|floatformat:0 }}</h3>
                        <p>Facturado</p>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="stat-card position-relative" id="pendingCard">
                        <i class="fas fa-clock icon text-warning"></i>
                        <h3 id="statPendingDocs">{{ stats.pending_invoices|default:"0" }}</h3>
                        <p>Pendientes</p>
                        <div id="processingIndicator" class="processing-indicator" style="display: none;">
                            <i class="fas fa-cog"></i>
                            <span>Procesando...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#dashboardTab">
                        <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#documentosTab">
                        <i class="fas fa-file-alt me-1"></i>Documentos
                        <span class="badge bg-warning ms-1" id="processingBadge" style="display: none;">0</span>
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#celeryTab">
                        <i class="fas fa-tasks me-1"></i>Procesamiento
                        <span class="badge bg-info ms-1" id="celeryTasksBadge">0</span>
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#planesTab">
                        <i class="fas fa-shopping-cart me-1"></i>Planes
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- Dashboard Tab -->
                <div class="tab-pane fade show active" id="dashboardTab">
                    <div class="row">
                        <div class="col-lg-4 mb-4">
                            {% if billing_available and billing_profile %}
                            <div class="section-card">
                                <div class="section-title">Estado del Plan</div>
                                
                                <div class="text-center mb-3">
                                    {% if current_plan %}
                                        <div class="plan-badge mb-2">{{ current_plan.name }}</div>
                                    {% else %}
                                        <div class="plan-badge no-plan mb-2">Sin Plan Activo</div>
                                    {% endif %}
                                    
                                    <div class="invoice-counter {% if billing_profile.available_invoices == 0 %}danger{% elif billing_profile.available_invoices <= 5 %}warning{% else %}success{% endif %}">
                                        {{ billing_profile.available_invoices|default:"0" }}
                                    </div>
                                    <p class="text-muted small">Documentos Disponibles</p>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <small>Progreso</small>
                                        <small>{{ billing_profile.total_invoices_consumed|default:"0" }} / {{ billing_profile.total_invoices_purchased|default:"0" }}</small>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" 
                                            style="width: {% widthratio billing_profile.total_invoices_consumed billing_profile.total_invoices_purchased 100 %}%">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="metric-card">
                                    <div class="value">${{ billing_profile.total_spent|default:"0"|floatformat:2 }}</div>
                                    <div class="label">Total Invertido</div>
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <div class="col-lg-8">
                            <div class="section-card">
                                <div class="section-title">Análisis de Documentos</div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="chart-container">
                                            <canvas id="documentsByMonthChart"></canvas>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="chart-container">
                                            <canvas id="documentStatusChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Documentos Tab -->
                <div class="tab-pane fade" id="documentosTab">
                    <div class="section-card">
                        <div class="documents-controls">
                            <div class="section-title mb-0">
                                Todos los Documentos
                                <span class="live-indicator ms-2">
                                    <span>Actualizando en vivo</span>
                                </span>
                            </div>
                            
                            <div class="documents-filters">
                                <select class="form-select form-select-sm" id="documentTypeFilter" onchange="filterDocuments()">
                                    <option value="">Todos los documentos</option>
                                    <option value="factura">Facturas</option>
                                    <option value="retencion">Retenciones</option>
                                    <option value="liquidacion">Liquidaciones de Compra</option>
                                    <option value="nota_credito">Notas de Crédito</option>
                                    <option value="nota_debito">Notas de Débito</option>
                                </select>
                                
                                <div class="btn-group">
                                    <button class="btn btn-outline-success btn-sm" onclick="processAllPendingDocuments()" id="processAllBtn">
                                        <i class="fas fa-play me-1"></i>Procesar Todos
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="stopAllProcessing()" id="stopAllBtn">
                                        <i class="fas fa-stop me-1"></i>Detener Todo
                                    </button>
                                </div>
                            </div>
                            
                            <div class="documents-metrics">
                                <div class="metric-card">
                                    <div class="label">Total</div>
                                    <div class="value" id="documentCount">{{ stats.total_invoices|default:"0" }}</div>
                                </div>
                                <div class="metric-card">
                                    <div class="label">Monto</div>
                                    <div class="value" id="documentAmount">${{ stats.total_amount|default:"0"|floatformat:2 }}</div>
                                </div>
                                <div class="metric-card">
                                    <div class="label">Procesando</div>
                                    <div class="value text-info" id="processingCount">0</div>
                                </div>
                            </div>
                        </div>
                        
                        {% if recent_invoices %}
                        <div class="table-responsive">
                            <table class="table table-custom" id="documentsTable">
                                <thead>
                                    <tr>
                                        <th>Tipo</th>
                                        <th>Número</th>
                                        <th>Cliente</th>
                                        <th>Monto</th>
                                        <th>Estado</th>
                                        <th>Progreso</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for document in recent_invoices %}
                                    <tr data-document-type="{{ document.mapped_type }}" 
                                        data-amount="{{ document.total_amount }}" 
                                        data-document-id="{{ document.id }}"
                                        id="docRow{{ document.id }}">
                                        <td>
                                            {% if document.document_type == 'INVOICE' %}
                                                <span class="badge bg-primary"><i class="fas fa-file-invoice"></i> Factura</span>
                                            {% elif document.document_type == 'CREDIT_NOTE' %}
                                                <span class="badge bg-warning text-dark"><i class="fas fa-file-minus"></i> N. Crédito</span>
                                            {% else %}
                                                <span class="badge bg-primary"><i class="fas fa-file-invoice"></i> Documento</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ document.document_number|default:document.id }}</td>
                                        <td>{{ document.client_name|default:"Cliente" }}</td>
                                        <td>${{ document.total_amount|floatformat:2 }}</td>
                                        <td>
                                            <span class="document-status" id="status{{ document.id }}">
                                                {% if document.status == 'DRAFT' %}
                                                    <span class="badge-status badge-pending">Borrador</span>
                                                {% elif document.status == 'GENERATED' %}
                                                    <span class="badge-status badge-pending">Generado</span>
                                                {% elif document.status == 'SENT' %}
                                                    <span class="badge-status badge-processing">Enviado</span>
                                                {% elif document.status == 'AUTHORIZED' %}
                                                    <span class="badge-status badge-approved">Autorizado</span>
                                                {% else %}
                                                    <span class="badge-status badge-pending">{{ document.status }}</span>
                                                {% endif %}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="progress-tracker" id="progress{{ document.id }}" style="display: none;">
                                                <div class="progress-steps">
                                                    <div class="progress-step" data-step="xml">
                                                        <div class="progress-step-circle">
                                                            <i class="fas fa-file-code"></i>
                                                        </div>
                                                        <div class="progress-step-label">XML</div>
                                                    </div>
                                                    <div class="progress-step" data-step="sign">
                                                        <div class="progress-step-circle">
                                                            <i class="fas fa-signature"></i>
                                                        </div>
                                                        <div class="progress-step-label">Firma</div>
                                                    </div>
                                                    <div class="progress-step" data-step="sri">
                                                        <div class="progress-step-circle">
                                                            <i class="fas fa-paper-plane"></i>
                                                        </div>
                                                        <div class="progress-step-label">SRI</div>
                                                    </div>
                                                    <div class="progress-step" data-step="pdf">
                                                        <div class="progress-step-circle">
                                                            <i class="fas fa-file-pdf"></i>
                                                        </div>
                                                        <div class="progress-step-label">PDF</div>
                                                    </div>
                                                </div>
                                                <div class="text-center">
                                                    <small class="text-muted" id="progressText{{ document.id }}">Iniciando...</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex gap-1 align-items-center">
                                                {% if document.status != 'AUTHORIZED' %}
                                                <button class="process-btn start" 
                                                        onclick="startAsyncProcessing({{ document.id }})" 
                                                        id="processBtn{{ document.id }}"
                                                        title="Procesar documento">
                                                    <i class="fas fa-play"></i>
                                                </button>
                                                <button class="process-btn stop" 
                                                        onclick="stopDocumentProcessing({{ document.id }})" 
                                                        id="stopBtn{{ document.id }}"
                                                        style="display: none;"
                                                        title="Detener procesamiento">
                                                    <i class="fas fa-stop"></i>
                                                </button>
                                                {% endif %}
                                                
                                                <button class="btn btn-sm btn-outline-primary" 
                                                        onclick="viewDocumentDetail({{ document.id }})" 
                                                        title="Ver detalle">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                
                                                {% if document.status == 'AUTHORIZED' %}
                                                <button class="btn btn-sm btn-outline-success" 
                                                        onclick="downloadDocumentFile({{ document.id }}, 'pdf')" 
                                                        title="Descargar PDF">
                                                    <i class="fas fa-file-pdf"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No hay documentos registrados</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Tab de Celery -->
                <div class="tab-pane fade" id="celeryTab">
                    <div class="row mb-4">
                        <div class="col-lg-8">
                            <div class="celery-card">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h3>Sistema de Procesamiento</h3>
                                        <p class="mb-0 opacity-75">Monitoreo en tiempo real de Celery</p>
                                    </div>
                                    <div class="text-end">
                                        <div class="metric" id="celeryWorkersCount">-</div>
                                        <small>Workers Activos</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="section-card">
                                <div class="section-title">Controles del Sistema</div>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary" onclick="testCeleryConnection()">
                                        <i class="fas fa-network-wired me-2"></i>Test Conexión
                                    </button>
                                    <button class="btn btn-outline-info" onclick="refreshCeleryStats()">
                                        <i class="fas fa-sync-alt me-2"></i>Actualizar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="label">Tareas Activas</div>
                                <div class="value text-info" id="activeTasks">0</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="label">Mis Tareas</div>
                                <div class="value text-success" id="myActiveTasks">0</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="label">Workers</div>
                                <div class="value text-primary" id="workersCount">0</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="label">Estado</div>
                                <div class="value" id="systemStatus">
                                    <i class="fas fa-circle text-secondary"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="section-card">
                        <div class="section-title">
                            Mis Tareas Activas
                            <span class="live-indicator ms-2">
                                <span>Actualizando cada 5s</span>
                            </span>
                        </div>
                        
                        <div id="userTasksList" class="task-list">
                            <div class="text-center py-3 text-muted">
                                <i class="fas fa-tasks fa-2x mb-2"></i>
                                <p>Cargando tareas activas...</p>
                            </div>
                        </div>
                    </div>

                    <div class="section-card">
                        <div class="section-title">Workers Activos</div>
                        <div id="workerDetails" class="task-list">
                            <div class="text-center py-3 text-muted">
                                <i class="fas fa-server fa-2x mb-2"></i>
                                <p>Cargando información de workers...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab de Planes -->
                <div class="tab-pane fade" id="planesTab">
                    <div class="section-card">
                        <div class="section-title">Planes Disponibles</div>
                        
                        {% if billing_available and all_plans %}
                        <div class="plan-selector">
                            {% for plan in all_plans %}
                            <div class="plan-option {% if plan == current_plan %}selected{% endif %}">
                                <h5>{{ plan.name }}</h5>
                                <div class="plan-price">${{ plan.price|floatformat:0 }}</div>
                                <p class="text-muted small mb-2">{{ plan.invoice_limit }} documentos</p>
                                
                                {% if plan == current_plan %}
                                <span class="badge bg-success">Plan Actual</span>
                                {% else %}
                                <a href="{% url 'billing:plan_purchase' plan.id %}?company={{ selected_company.id }}" 
                                   class="btn btn-primary btn-sm mt-2">
                                    Comprar
                                </a>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No hay planes disponibles</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-building fa-4x text-muted mb-3"></i>
                <h3 class="text-muted">No hay empresa seleccionada</h3>
                <p>Selecciona una empresa para comenzar</p>
            </div>
        {% endif %}
    </div>

    <!-- Modal de Edición de Empresa -->
    <div class="modal fade" id="editCompanyModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-building me-2"></i>Editar Información de la Empresa
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editCompanyForm" method="post" action="{% url 'core:company_update' selected_company.id %}">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="business_name" class="form-label">Razón Social</label>
                            <input type="text" class="form-control" id="business_name" name="business_name" 
                                   value="{{ selected_company.business_name }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email" 
                                   value="{{ selected_company.email }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="address" class="form-label">Dirección</label>
                            <textarea class="form-control" id="address" name="address" rows="2" required>{{ selected_company.address }}</textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner-border text-primary mb-3"></div>
            <h5>Procesando documentos...</h5>
            <p class="text-muted">Por favor espere...</p>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="notification-toast"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        /* ==========================================
           VARIABLES GLOBALES Y CONFIGURACIÓN
           ========================================== */
        var pollingInterval = null;
        var documentPollingIntervals = new Map();
        var celeryPollingInterval = null;

        /* ==========================================
           INICIALIZACIÓN
           ========================================== */
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard iniciado');
            
            // Configurar gráficas
            initializeCharts();
            
            // Inicializar monitoreo de Celery
            initializeCeleryMonitoring();
            
            // Configurar tabs
            setupTabHandlers();
            
            // Verificar parámetros URL
            checkForSuccessMessages();
        });

        /* ==========================================
           GRÁFICAS
           ========================================== */
        function initializeCharts() {
            try {
                var authorizedDocuments = parseInt('{{ stats.authorized_invoices|default:"0" }}');
                var pendingDocuments = parseInt('{{ stats.pending_invoices|default:"0" }}');
                var rejectedDocuments = parseInt('{{ stats.rejected_invoices|default:"0" }}');

                // Gráfica de documentos por mes
                var monthCtx = document.getElementById('documentsByMonthChart');
                if (monthCtx) {
                    new Chart(monthCtx, {
                        type: 'line',
                        data: {
                            labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
                            datasets: [{
                                label: 'Documentos',
                                data: [5, 8, 12, 7, 15, 10],
                                borderColor: '#0d6efd',
                                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { y: { beginAtZero: true } }
                        }
                    });
                }

                // Gráfica de estado de documentos
                var statusCtx = document.getElementById('documentStatusChart');
                if (statusCtx) {
                    new Chart(statusCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Autorizados', 'Pendientes', 'Rechazados'],
                            datasets: [{
                                data: [authorizedDocuments, pendingDocuments, rejectedDocuments],
                                backgroundColor: ['#28a745', '#ffc107', '#dc3545']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'bottom' } }
                        }
                    });
                }
            } catch (error) {
                console.error('Error inicializando gráficas:', error);
            }
        }

        /* ==========================================
           MONITOREO DE CELERY
           ========================================== */
        function initializeCeleryMonitoring() {
            console.log('Iniciando monitoreo de Celery');
            
            // Verificar estado inicial
            checkCeleryStatus();
            
            // Polling cada 5 segundos
            celeryPollingInterval = setInterval(function() {
                checkCeleryStatus();
                updateUserActiveTasks();
            }, 5000);
        }

        function checkCeleryStatus() {
            fetch('/api/sri/celery/status/', {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                var headerStatus = document.getElementById('headerCeleryStatus');
                var workersCount = document.getElementById('celeryWorkersCount');
                var systemStatus = document.getElementById('systemStatus');
                
                if (data.celery_healthy) {
                    headerStatus.className = 'celery-status healthy';
                    headerStatus.innerHTML = '<i class="fas fa-check-circle"></i><span>Sistema operativo (' + data.workers_count + ' workers)</span>';
                    
                    if (workersCount) workersCount.textContent = data.workers_count;
                    if (systemStatus) systemStatus.innerHTML = '<i class="fas fa-circle text-success"></i>';
                } else {
                    headerStatus.className = 'celery-status unhealthy';
                    headerStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Sistema no disponible</span>';
                    
                    if (workersCount) workersCount.textContent = '0';
                    if (systemStatus) systemStatus.innerHTML = '<i class="fas fa-circle text-danger"></i>';
                }
            })
            .catch(function(error) {
                console.error('Error checking Celery status:', error);
                var headerStatus = document.getElementById('headerCeleryStatus');
                headerStatus.className = 'celery-status unhealthy';
                headerStatus.innerHTML = '<i class="fas fa-times-circle"></i><span>Error de conexión</span>';
            });
        }

        function updateUserActiveTasks() {
            fetch('/api/sri/celery/my-tasks/')
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                var tasksBadge = document.getElementById('celeryTasksBadge');
                var myActiveTasksCounter = document.getElementById('myActiveTasks');
                var processingBadge = document.getElementById('processingBadge');
                var processingCount = document.getElementById('processingCount');
                var processingIndicator = document.getElementById('processingIndicator');
                
                if (tasksBadge) {
                    tasksBadge.textContent = data.count;
                    tasksBadge.style.display = data.count > 0 ? 'inline' : 'none';
                }
                
                if (myActiveTasksCounter) myActiveTasksCounter.textContent = data.count;
                if (processingCount) processingCount.textContent = data.count;
                
                if (processingBadge) {
                    processingBadge.textContent = data.count;
                    processingBadge.style.display = data.count > 0 ? 'inline' : 'none';
                }
                
                if (processingIndicator) {
                    processingIndicator.style.display = data.count > 0 ? 'flex' : 'none';
                }
                
                updateTasksList(data.active_tasks);
            })
            .catch(function(error) {
                console.error('Error updating user active tasks:', error);
            });
        }

        function updateTasksList(tasks) {
            var tasksList = document.getElementById('userTasksList');
            if (!tasksList) return;
            
            if (tasks.length === 0) {
                tasksList.innerHTML = '<div class="text-center py-3 text-muted">' +
                    '<i class="fas fa-check-circle fa-2x mb-2 text-success"></i>' +
                    '<p>No hay tareas activas</p></div>';
                return;
            }
            
            var tasksHtml = '';
            for (var i = 0; i < tasks.length; i++) {
                var task = tasks[i];
                var elapsedTime = task.elapsed_time ? 
                    Math.floor(task.elapsed_time / 60) + 'm ' + (task.elapsed_time % 60) + 's' : 'N/A';
                
                tasksHtml += '<div class="task-item">';
                tasksHtml += '<div class="task-details">';
                tasksHtml += '<div class="d-flex justify-content-between align-items-center">';
                tasksHtml += '<strong>Documento ' + task.document_id + '</strong>';
                tasksHtml += '<span class="badge bg-info"><i class="fas fa-cog fa-spin"></i> ' + task.status + '</span>';
                tasksHtml += '</div>';
                tasksHtml += '<div class="task-id">Task: ' + task.task_id + '</div>';
                tasksHtml += '<small class="text-muted">' + task.operation + ' • ' + elapsedTime + '</small>';
                tasksHtml += '</div>';
                tasksHtml += '<button class="btn btn-sm btn-outline-danger" ';
                tasksHtml += 'onclick="stopDocumentProcessing(' + task.document_id + ')" title="Cancelar">';
                tasksHtml += '<i class="fas fa-times"></i></button>';
                tasksHtml += '</div>';
            }
            
            tasksList.innerHTML = tasksHtml;
        }

        /* ==========================================
           PROCESAMIENTO ASÍNCRONO
           ========================================== */
        function startAsyncProcessing(documentId) {
            console.log('Iniciando procesamiento de documento:', documentId);
            
            showLoadingToast('Iniciando procesamiento del documento ' + documentId + '...');
            
            fetch('/api/sri/documents/' + documentId + '/process-celery/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    showNotification('Procesamiento iniciado exitosamente', 'success');
                    
                    // Mostrar progreso
                    showDocumentProgress(documentId);
                    
                    // Cambiar botones
                    var processBtn = document.getElementById('processBtn' + documentId);
                    var stopBtn = document.getElementById('stopBtn' + documentId);
                    
                    if (processBtn) processBtn.style.display = 'none';
                    if (stopBtn) stopBtn.style.display = 'inline-block';
                    
                    // Iniciar polling específico
                    startDocumentSpecificPolling(documentId);
                    
                    showNotification('Documento ' + documentId + ' en procesamiento', 'info');
                } else {
                    showNotification(data.message || 'Error iniciando procesamiento', 'danger');
                }
            })
            .catch(function(error) {
                console.error('Error starting async processing:', error);
                showNotification('Error de conexión al iniciar procesamiento', 'danger');
            });
        }

        function stopDocumentProcessing(documentId) {
            if (!confirm('¿Detener el procesamiento de este documento?')) {
                return;
            }
            
            fetch('/api/sri/documents/' + documentId + '/stop-processing/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    showNotification('Procesamiento detenido', 'warning');
                    
                    // Ocultar progreso
                    hideDocumentProgress(documentId);
                    
                    // Cambiar botones
                    var processBtn = document.getElementById('processBtn' + documentId);
                    var stopBtn = document.getElementById('stopBtn' + documentId);
                    
                    if (processBtn) processBtn.style.display = 'inline-block';
                    if (stopBtn) stopBtn.style.display = 'none';
                    
                    // Detener polling
                    stopDocumentSpecificPolling(documentId);
                } else {
                    showNotification('Error deteniendo procesamiento', 'danger');
                }
            })
            .catch(function(error) {
                console.error('Error stopping processing:', error);
                showNotification('Error de conexión', 'danger');
            });
        }

        function showDocumentProgress(documentId) {
            var progressContainer = document.getElementById('progress' + documentId);
            if (progressContainer) {
                progressContainer.style.display = 'block';
                
                var steps = progressContainer.querySelectorAll('.progress-step');
                steps.forEach(function(step) {
                    step.classList.remove('completed', 'active', 'failed');
                });
                
                var firstStep = progressContainer.querySelector('[data-step="xml"]');
                if (firstStep) firstStep.classList.add('active');
                
                var progressText = document.getElementById('progressText' + documentId);
                if (progressText) progressText.textContent = 'Generando XML...';
            }
        }

        function hideDocumentProgress(documentId) {
            var progressContainer = document.getElementById('progress' + documentId);
            if (progressContainer) {
                progressContainer.style.display = 'none';
            }
        }

        function updateDocumentStatus(documentId, newStatus) {
            var statusElement = document.getElementById('status' + documentId);
            if (!statusElement) return;
            
            var statusBadges = {
                'DRAFT': '<span class="badge-status badge-pending">Borrador</span>',
                'GENERATED': '<span class="badge-status badge-pending">Generado</span>',
                'SIGNED': '<span class="badge-status badge-pending">Firmado</span>',
                'SENT': '<span class="badge-status badge-processing">Enviado</span>',
                'AUTHORIZED': '<span class="badge-status badge-approved">Autorizado</span>',
                'REJECTED': '<span class="badge-status badge-rejected">Rechazado</span>',
                'ERROR': '<span class="badge-status badge-rejected">Error</span>'
            };
            
            statusElement.innerHTML = statusBadges[newStatus] || '<span class="badge-status badge-pending">' + newStatus + '</span>';
        }

        function startDocumentSpecificPolling(documentId) {
            stopDocumentSpecificPolling(documentId);
            
            var interval = setInterval(function() {
                fetch('/api/sri/documents/' + documentId + '/task-status/')
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    updateDocumentStatus(documentId, data.current_status);
                    
                    if (!data.has_active_processing) {
                        stopDocumentSpecificPolling(documentId);
                        
                        if (data.current_status === 'AUTHORIZED') {
                            setTimeout(function() {
                                hideDocumentProgress(documentId);
                                showConfetti();
                                showNotification('¡Documento ' + documentId + ' autorizado!', 'success');
                            }, 2000);
                        }
                        
                        var processBtn = document.getElementById('processBtn' + documentId);
                        var stopBtn = document.getElementById('stopBtn' + documentId);
                        
                        if (data.current_status !== 'AUTHORIZED' && processBtn) {
                            processBtn.style.display = 'inline-block';
                        }
                        if (stopBtn) stopBtn.style.display = 'none';
                    }
                })
                .catch(function(error) {
                    console.error('Error polling document:', error);
                    stopDocumentSpecificPolling(documentId);
                });
            }, 3000);
            
            documentPollingIntervals.set(documentId, interval);
        }

        function stopDocumentSpecificPolling(documentId) {
            var interval = documentPollingIntervals.get(documentId);
            if (interval) {
                clearInterval(interval);
                documentPollingIntervals.delete(documentId);
            }
        }

        /* ==========================================
           PROCESAMIENTO MASIVO
           ========================================== */
        function processAllPendingDocuments() {
            if (!confirm('¿Procesar todos los documentos pendientes?')) {
                return;
            }
            
            var pendingRows = document.querySelectorAll('#documentsTable tbody tr');
            var pendingDocuments = [];
            
            pendingRows.forEach(function(row) {
                var documentId = row.getAttribute('data-document-id');
                var statusElement = row.querySelector('.document-status span');
                var status = statusElement ? statusElement.textContent.trim() : '';
                
                if (['Borrador', 'Generado', 'Error'].includes(status)) {
                    pendingDocuments.push(documentId);
                }
            });
            
            if (pendingDocuments.length === 0) {
                showNotification('No hay documentos pendientes para procesar', 'info');
                return;
            }
            
            showLoadingOverlay();
            showNotification('Iniciando procesamiento de ' + pendingDocuments.length + ' documentos...', 'info');
            
            // Procesar cada documento con delay
            var index = 0;
            function processNext() {
                if (index < pendingDocuments.length) {
                    startAsyncProcessing(pendingDocuments[index]);
                    index++;
                    setTimeout(processNext, 1000); // 1 segundo entre cada documento
                } else {
                    hideLoadingOverlay();
                    showNotification('Procesamiento masivo iniciado', 'success');
                }
            }
            
            processNext();
        }

        function stopAllProcessing() {
            if (!confirm('¿Detener todo el procesamiento activo?')) {
                return;
            }
            
            showLoadingToast('Deteniendo procesamientos...');
            
            fetch('/api/sri/celery/my-tasks/')
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                var promises = [];
                for (var i = 0; i < data.active_tasks.length; i++) {
                    promises.push(stopDocumentProcessing(data.active_tasks[i].document_id));
                }
                
                Promise.all(promises).then(function() {
                    showNotification(data.active_tasks.length + ' procesamientos detenidos', 'warning');
                });
            })
            .catch(function(error) {
                console.error('Error stopping all processing:', error);
                showNotification('Error deteniendo procesamientos', 'danger');
            });
        }

        /* ==========================================
           TESTING Y CONTROLES
           ========================================== */
        function testCeleryConnection() {
            showLoadingToast('Probando conexión con Celery...');
            
            fetch('/api/sri/celery/test/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    showNotification('✅ Celery conectado - ' + data.workers_active + ' workers activos', 'success');
                    refreshCeleryStats();
                } else {
                    showNotification('❌ Celery no responde', 'danger');
                }
            })
            .catch(function(error) {
                console.error('Error testing Celery:', error);
                showNotification('Error probando conexión', 'danger');
            });
        }

        function refreshCeleryStats() {
            checkCeleryStatus();
            updateUserActiveTasks();
            showNotification('Estadísticas actualizadas', 'info');
        }

        /* ==========================================
           FUNCIONES DE DOCUMENTOS
           ========================================== */
        function filterDocuments() {
            var filterValue = document.getElementById('documentTypeFilter').value;
            var rows = document.querySelectorAll('#documentsTable tbody tr');
            var visibleCount = 0;
            var totalAmount = 0;
            
            rows.forEach(function(row) {
                if (row.id === 'noDocumentsMessage') return;
                
                var documentType = row.getAttribute('data-document-type');
                var amount = parseFloat(row.getAttribute('data-amount') || '0');
                
                if (filterValue === '' || documentType === filterValue) {
                    row.style.display = '';
                    visibleCount++;
                    totalAmount += amount;
                } else {
                    row.style.display = 'none';
                }
            });
            
            document.getElementById('documentCount').textContent = visibleCount;
            document.getElementById('documentAmount').textContent = '$' + totalAmount.toFixed(2);
        }

        function downloadDocumentFile(documentId, fileType) {
            showLoadingToast('Descargando ' + fileType.toUpperCase() + '...');
            
            var downloadUrl = '/sri/documents/' + documentId + '/download/' + fileType + '/';
            var link = document.createElement('a');
            link.href = downloadUrl;
            link.download = '';
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            setTimeout(function() {
                showNotification(fileType.toUpperCase() + ' descargado', 'success');
            }, 1000);
        }

        function viewDocumentDetail(documentId) {
            showNotification('Detalle del documento ' + documentId, 'info');
        }

        /* ==========================================
           FUNCIONES DE UI
           ========================================== */
        function openEditCompanyModal() {
            var modal = new bootstrap.Modal(document.getElementById('editCompanyModal'));
            modal.show();
        }

        function showLoadingOverlay() {
            var overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.style.display = 'flex';
        }

        function hideLoadingOverlay() {
            var overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.style.display = 'none';
        }

        function setupTabHandlers() {
            var activeTab = localStorage.getItem('activeTab');
            if (activeTab) {
                var tabElement = document.querySelector('[data-bs-target="' + activeTab + '"]');
                if (tabElement) {
                    var tab = new bootstrap.Tab(tabElement);
                    tab.show();
                }
            }

            var tabs = document.querySelectorAll('[data-bs-toggle="tab"]');
            tabs.forEach(function(tab) {
                tab.addEventListener('shown.bs.tab', function (e) {
                    localStorage.setItem('activeTab', e.target.getAttribute('data-bs-target'));
                    
                    if (e.target.getAttribute('data-bs-target') === '#celeryTab') {
                        refreshCeleryStats();
                    }
                });
            });
        }

        function checkForSuccessMessages() {
            var urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('purchase_approved') === 'true') {
                showConfetti();
                showNotification('¡Compra aprobada exitosamente!', 'success');
            }
        }

        function activarTabPlanes() {
            var planesTabButton = document.querySelector('[data-bs-target="#planesTab"]');
            if (planesTabButton) {
                var tab = new bootstrap.Tab(planesTabButton);
                tab.show();
            }
        }

        function toggleTokenVisibility() {
            var tokenElement = document.getElementById('companyToken');
            var toggleIcon = document.getElementById('toggleToken');
            var actualToken = tokenElement.getAttribute('data-token');
            
            if (tokenElement.textContent.includes('•')) {
                tokenElement.textContent = actualToken;
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            } else {
                tokenElement.textContent = '••••••••••••••••••••••••••••••••••••••••';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            }
        }

        function copyToken() {
            var tokenElement = document.getElementById('companyToken');
            if (tokenElement) {
                var token = tokenElement.getAttribute('data-token');
                navigator.clipboard.writeText(token).then(function() {
                    showNotification('Token copiado al portapapeles', 'success');
                }).catch(function(err) {
                    showNotification('Error al copiar el token', 'danger');
                });
            }
        }

        function showNotification(message, type) {
            if (!type) type = 'success';
            
            var toastHtml = '<div class="toast show align-items-center text-white bg-' + type + ' border-0" role="alert">';
            toastHtml += '<div class="d-flex">';
            toastHtml += '<div class="toast-body">' + message + '</div>';
            toastHtml += '<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>';
            toastHtml += '</div></div>';
            
            var container = document.getElementById('toastContainer');
            container.insertAdjacentHTML('beforeend', toastHtml);
            
            setTimeout(function() {
                var toast = container.lastElementChild;
                if (toast) toast.remove();
            }, 5000);
        }

        function showLoadingToast(message) {
            var toastHtml = '<div class="toast show align-items-center text-white bg-info border-0" role="alert" id="loadingToast">';
            toastHtml += '<div class="d-flex">';
            toastHtml += '<div class="toast-body"><i class="fas fa-spinner fa-spin me-2"></i>' + message + '</div>';
            toastHtml += '</div></div>';
            
            var container = document.getElementById('toastContainer');
            container.insertAdjacentHTML('beforeend', toastHtml);
            
            setTimeout(function() {
                var toast = document.getElementById('loadingToast');
                if (toast) toast.remove();
            }, 5000);
        }

        function showConfetti() {
            if (typeof confetti === 'function') {
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }
        }

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        /* ==========================================
           CLEANUP
           ========================================== */
        window.addEventListener('beforeunload', function() {
            if (pollingInterval) clearInterval(pollingInterval);
            if (celeryPollingInterval) clearInterval(celeryPollingInterval);
            
            documentPollingIntervals.forEach(function(interval) {
                clearInterval(interval);
            });
            documentPollingIntervals.clear();
        });
    </script>
</body>
</html>