{% extends "custom_admin/base.html" %}
{% load static %}

{% block header_title %}Dashboard{% endblock %}

{% block extra_css %}
<style>
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .activity-item {
        padding: 15px;
        border-bottom: 1px solid #e9ecef;
        transition: background 0.2s ease;
    }
    
    .activity-item:hover {
        background: #f8f9fa;
    }
    
    .activity-item:last-child {
        border-bottom: none;
    }
    
    .activity-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        margin-right: 15px;
    }
    
    .activity-icon.create { background: #d4edda; color: #155724; }
    .activity-icon.update { background: #cce5ff; color: #004085; }
    .activity-icon.delete { background: #f8d7da; color: #721c24; }
    .activity-icon.login { background: #d1ecf1; color: #0c5460; }
    
    .chart-container {
        position: relative;
        height: 300px;
        margin-top: 20px;
    }
    
    .quick-action {
        text-align: center;
        padding: 20px;
        border-radius: 10px;
        transition: all 0.3s ease;
        cursor: pointer;
        text-decoration: none;
        display: block;
        color: inherit;
    }
    
    .quick-action:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        text-decoration: none;
        color: inherit;
    }
    
    .quick-action-icon {
        font-size: 3rem;
        margin-bottom: 10px;
        opacity: 0.8;
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-0">Dashboard Administrativo</h2>
        <p class="text-muted mb-0">Bienvenido de vuelta, {{ user.get_display_name|default:user.email }}</p>
    </div>
    <div>
        <button class="btn btn-admin btn-admin-primary" onclick="location.reload()">
            <i class="fas fa-sync-alt"></i> Actualizar
        </button>
    </div>
</div>

<!-- Statistics Cards -->
<div class="dashboard-grid">
    <!-- Users Card -->
    <div class="stat-card">
        <i class="fas fa-users stat-icon"></i>
        <div class="stat-label">Total Usuarios</div>
        <div class="stat-value" id="stat-total_users">{{ total_users|default:"0" }}</div>
        <div class="stat-change positive">
            <i class="fas fa-arrow-up"></i> <span id="stat-new_users_today">{{ new_users_today|default:"0" }}</span> hoy
        </div>
    </div>
    
    <!-- Active Users Card -->
    <div class="stat-card success">
        <i class="fas fa-user-check stat-icon"></i>
        <div class="stat-label">Usuarios Activos</div>
        <div class="stat-value" id="stat-active_users">{{ active_users|default:"0" }}</div>
        <div class="stat-change">
            {% if total_users > 0 %}
                {{ active_users|floatformat:0 }}% del total
            {% else %}
                0% del total
            {% endif %}
        </div>
    </div>
    
    <!-- Pending Users Card -->
    <div class="stat-card warning">
        <i class="fas fa-user-clock stat-icon"></i>
        <div class="stat-label">En Espera</div>
        <div class="stat-value" id="stat-pending_users">{{ pending_users|default:"0" }}</div>
        {% if pending_users > 0 %}
            <div class="stat-change">
                <a href="{% url 'custom_admin:users' %}?status=waiting" class="text-warning">
                    Ver usuarios pendientes
                </a>
            </div>
        {% endif %}
    </div>
    
    <!-- Companies Card -->
    <div class="stat-card info">
        <i class="fas fa-building stat-icon"></i>
        <div class="stat-label">Total Empresas</div>
        <div class="stat-value" id="stat-total_companies">{{ total_companies|default:"0" }}</div>
        <div class="stat-change">
            <span id="stat-active_companies">{{ active_companies|default:"0" }}</span> activas
        </div>
    </div>
    
    <!-- Certificates Card -->
    <div class="stat-card">
        <i class="fas fa-certificate stat-icon"></i>
        <div class="stat-label">Certificados</div>
        <div class="stat-value" id="stat-total_certificates">{{ total_certificates|default:"0" }}</div>
        {% if expiring_certificates > 0 %}
            <div class="stat-change negative">
                <i class="fas fa-exclamation-triangle"></i> <span id="stat-expiring_certificates">{{ expiring_certificates }}</span> por expirar
            </div>
        {% endif %}
    </div>
    
    <!-- Notifications Card -->
    <div class="stat-card danger">
        <i class="fas fa-bell stat-icon"></i>
        <div class="stat-label">Notificaciones</div>
        <div class="stat-value" id="stat-unread_notifications">{{ unread_notifications|default:"0" }}</div>
        {% if unread_notifications > 0 %}
            <div class="stat-change">
                <a href="{% url 'custom_admin:notifications' %}" class="text-danger">
                    Ver notificaciones
                </a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Quick Actions -->
<div class="admin-card mb-4">
    <div class="card-header">
        <h5 class="card-title">
            <i class="fas fa-rocket me-2"></i>Acciones Rápidas
        </h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3 col-sm-6 mb-3">
                <a href="{% url 'custom_admin:users' %}" class="quick-action bg-light">
                    <i class="fas fa-user-plus quick-action-icon text-primary"></i>
                    <h6>Nuevo Usuario</h6>
                </a>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <a href="{% url 'custom_admin:companies' %}" class="quick-action bg-light">
                    <i class="fas fa-building quick-action-icon text-success"></i>
                    <h6>Nueva Empresa</h6>
                </a>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <a href="{% url 'custom_admin:certificates' %}" class="quick-action bg-light">
                    <i class="fas fa-certificate quick-action-icon text-warning"></i>
                    <h6>Nuevo Certificado</h6>
                </a>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <a href="{% url 'custom_admin:export_data' 'users' %}" class="quick-action bg-light">
                    <i class="fas fa-download quick-action-icon text-info"></i>
                    <h6>Exportar Datos</h6>
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Charts Column -->
    <div class="col-lg-8">
        <!-- Users Chart -->
        <div class="admin-card mb-4">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-chart-line me-2"></i>Registro de Usuarios (Últimos 30 días)
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="usersChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Activity Chart -->
        <div class="admin-card">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-chart-bar me-2"></i>Actividad del Sistema (Últimos 7 días)
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="activityChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Activity Column -->
    <div class="col-lg-4">
        <!-- Recent Notifications -->
        {% if recent_notifications %}
        <div class="admin-card mb-4">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-bell me-2"></i>Notificaciones Recientes
                </h5>
                <div class="card-actions">
                    <a href="{% url 'custom_admin:notifications' %}" class="btn btn-sm btn-light">
                        Ver todas
                    </a>
                </div>
            </div>
            <div class="card-body p-0">
                {% for notification in recent_notifications %}
                <div class="activity-item">
                    <div class="d-flex align-items-start">
                        <div class="activity-icon {{ notification.priority }}">
                            <i class="fas fa-bell"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1">{{ notification.title }}</h6>
                            <p class="mb-1 text-muted small">{{ notification.message|truncatewords:15 }}</p>
                            <small class="text-muted">
                                <i class="far fa-clock me-1"></i>{{ notification.created_at|timesince }} atrás
                            </small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- Recent Activity -->
        <div class="admin-card">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-history me-2"></i>Actividad Reciente
                </h5>
                <div class="card-actions">
                    <a href="{% url 'custom_admin:audit_logs' %}" class="btn btn-sm btn-light">
                        Ver todo
                    </a>
                </div>
            </div>
            <div class="card-body p-0">
                {% if recent_logs %}
                    {% for log in recent_logs %}
                    <div class="activity-item">
                        <div class="d-flex align-items-start">
                            <div class="activity-icon {{ log.action|lower }}">
                                {% if log.action == 'CREATE' %}
                                    <i class="fas fa-plus"></i>
                                {% elif log.action == 'UPDATE' %}
                                    <i class="fas fa-edit"></i>
                                {% elif log.action == 'DELETE' %}
                                    <i class="fas fa-trash"></i>
                                {% elif log.action == 'LOGIN' %}
                                    <i class="fas fa-sign-in-alt"></i>
                                {% else %}
                                    <i class="fas fa-info"></i>
                                {% endif %}
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    {{ log.user.get_display_name|default:"Sistema" }}
                                    <span class="text-muted">{{ log.get_action_display|lower }}</span>
                                    {{ log.model_name }}
                                </h6>
                                <p class="mb-1 text-muted small">{{ log.object_representation|truncatewords:10 }}</p>
                                <small class="text-muted">
                                    <i class="far fa-clock me-1"></i>{{ log.created_at|timesince }} atrás
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="p-3 text-center text-muted">
                        No hay actividad reciente
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Configuración de colores globales
    const colors = {
        primary: '#3498db',
        success: '#27ae60',
        warning: '#f39c12',
        danger: '#e74c3c',
        info: '#00bcd4',
        secondary: '#34495e',
        light: '#ecf0f1',
        dark: '#2c3e50'
    };
    
    // Configuración global de Chart.js
    Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif';
    Chart.defaults.responsive = true;
    Chart.defaults.maintainAspectRatio = false;
    
    // Parsear datos del servidor Django
    let usersChartData = null;
    let activityChartData = null;
    
    try {
        // Intentar parsear los datos del servidor
        {% if users_chart_data %}
            usersChartData = {{ users_chart_data|safe }};
        {% endif %}
        
        {% if activity_chart_data %}
            activityChartData = {{ activity_chart_data|safe }};
        {% endif %}
    } catch (e) {
        console.log('Usando datos de ejemplo para las gráficas');
    }
    
    // ====================
    // Gráfica de Usuarios
    // ====================
    const usersCtx = document.getElementById('usersChart');
    if (usersCtx) {
        let chartData;
        
        // Usar datos del servidor si están disponibles, sino usar datos de ejemplo
        if (usersChartData && usersChartData.labels && usersChartData.data) {
            chartData = {
                labels: usersChartData.labels,
                data: usersChartData.data
            };
        } else {
            // Datos de ejemplo si no hay datos del servidor
            const labels = [];
            const data = [];
            const today = new Date();
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' }));
                
                // Datos de ejemplo con variación realista
                const baseValue = 2;
                const variation = Math.floor(Math.random() * 8);
                data.push(baseValue + variation);
            }
            
            chartData = { labels: labels, data: data };
        }
        
        new Chart(usersCtx, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [{
                    label: 'Nuevos Usuarios',
                    data: chartData.data,
                    borderColor: colors.primary,
                    backgroundColor: colors.primary + '20',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    pointBackgroundColor: colors.primary,
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        cornerRadius: 8,
                        titleFont: {
                            size: 14,
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 13
                        },
                        callbacks: {
                            label: function(context) {
                                return 'Usuarios: ' + context.parsed.y;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45,
                            font: {
                                size: 11
                            }
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            stepSize: Math.max(1, Math.floor(Math.max(...chartData.data) / 5)),
                            font: {
                                size: 11
                            },
                            callback: function(value) {
                                return Math.floor(value);
                            }
                        }
                    }
                }
            }
        });
    }
    
    // ====================
    // Gráfica de Actividad
    // ====================
    const activityCtx = document.getElementById('activityChart');
    if (activityCtx) {
        let chartData;
        
        // Usar datos del servidor si están disponibles, sino usar datos de ejemplo
        if (activityChartData && activityChartData.labels && activityChartData.datasets) {
            chartData = activityChartData;
        } else {
            // Datos de ejemplo si no hay datos del servidor
            const activityLabels = [];
            const loginData = [];
            const createData = [];
            const updateData = [];
            const deleteData = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                activityLabels.push(date.toLocaleDateString('es-ES', { weekday: 'short' }));
                
                // Datos de ejemplo más realistas
                loginData.push(Math.floor(Math.random() * 30) + 10);
                createData.push(Math.floor(Math.random() * 15) + 5);
                updateData.push(Math.floor(Math.random() * 20) + 8);
                deleteData.push(Math.floor(Math.random() * 5) + 1);
            }
            
            chartData = {
                labels: activityLabels,
                datasets: {
                    login: loginData,
                    create: createData,
                    update: updateData,
                    delete: deleteData
                }
            };
        }
        
        new Chart(activityCtx, {
            type: 'bar',
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        label: 'Inicios de Sesión',
                        data: chartData.datasets.login,
                        backgroundColor: colors.info,
                        borderRadius: 4,
                        barPercentage: 0.8,
                        categoryPercentage: 0.9
                    },
                    {
                        label: 'Creaciones',
                        data: chartData.datasets.create,
                        backgroundColor: colors.success,
                        borderRadius: 4,
                        barPercentage: 0.8,
                        categoryPercentage: 0.9
                    },
                    {
                        label: 'Actualizaciones',
                        data: chartData.datasets.update,
                        backgroundColor: colors.warning,
                        borderRadius: 4,
                        barPercentage: 0.8,
                        categoryPercentage: 0.9
                    },
                    {
                        label: 'Eliminaciones',
                        data: chartData.datasets.delete,
                        backgroundColor: colors.danger,
                        borderRadius: 4,
                        barPercentage: 0.8,
                        categoryPercentage: 0.9
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: {
                                size: 12
                            },
                            usePointStyle: true,
                            pointStyle: 'rectRounded'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        cornerRadius: 8,
                        titleFont: {
                            size: 14,
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 13
                        }
                    }
                },
                scales: {
                    x: {
                        stacked: false,
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                size: 11
                            }
                        }
                    },
                    y: {
                        stacked: false,
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            font: {
                                size: 11
                            },
                            callback: function(value) {
                                return Math.floor(value);
                            }
                        }
                    }
                }
            }
        });
    }
    
    // ====================
    // Animación de números
    // ====================
    function animateValue(element, start, end, duration) {
        if (!element) return;
        
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            element.textContent = Math.floor(progress * (end - start) + start);
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    }
    
    // Animar los contadores al cargar la página
    document.querySelectorAll('.stat-value').forEach(element => {
        const value = parseInt(element.textContent) || 0;
        if (value > 0) {
            element.textContent = '0';
            animateValue(element, 0, value, 1000);
        }
    });
});
</script>
{% endblock %}