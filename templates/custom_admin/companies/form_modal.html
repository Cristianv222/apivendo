<!-- templates/custom_admin/companies/form_modal.html -->
<form method="POST" action="{% if mode == 'edit' %}{% url 'custom_admin:company_edit' company.id %}{% else %}{% url 'custom_admin:company_create' %}{% endif %}"
      id="companyForm" class="needs-validation" novalidate>
    {% csrf_token %}
    
    <!-- Área de mensajes de error mejorada -->
    <div id="errorContainer"></div>
    
    {% if error %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>Error:</strong> {{ error }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}
    
    <div class="row">
        <!-- Basic Information -->
        <div class="col-md-6">
            <h6 class="text-muted mb-3">Información Básica</h6>
            
            <div class="mb-3">
                <label for="ruc" class="form-label">RUC <span class="text-danger">*</span></label>
                <div class="input-group">
                    <input type="text" class="form-control" id="ruc" name="ruc" 
                           value="{{ company.ruc|default:'' }}" 
                           pattern="[0-9]{13}" maxlength="13"
                           {% if mode == 'edit' %}readonly{% endif %}
                           required>
                    <span class="input-group-text" id="ruc-status">
                        <i class="fas fa-question-circle text-muted"></i>
                    </span>
                </div>
                <div class="invalid-feedback">
                    Por favor ingresa un RUC válido (13 dígitos).
                </div>
                <small class="form-text text-muted" id="ruc-message">
                    Formato: 13 dígitos (ej: 1234567890001)
                </small>
            </div>
            
            <div class="mb-3">
                <label for="business_name" class="form-label">Razón Social <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="business_name" name="business_name" 
                       value="{{ company.business_name|default:'' }}"
                       required>
                <div class="invalid-feedback">
                    La razón social es requerida.
                </div>
            </div>
            
            <div class="mb-3">
                <label for="trade_name" class="form-label">Nombre Comercial <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="trade_name" name="trade_name" 
                       value="{{ company.trade_name|default:'' }}"
                       required>
                <div class="invalid-feedback">
                    El nombre comercial es requerido.
                </div>
            </div>
            
            <div class="mb-3">
                <label for="email" class="form-label">Email Corporativo <span class="text-danger">*</span></label>
                <input type="email" class="form-control" id="email" name="email" 
                       value="{{ company.email|default:'' }}"
                       placeholder="contacto@empresa.com"
                       required>
                <div class="invalid-feedback">
                    Por favor ingresa un email válido.
                </div>
            </div>
            
            <div class="mb-3">
                <label for="phone" class="form-label">Teléfono</label>
                <input type="tel" class="form-control" id="phone" name="phone" 
                       value="{{ company.phone|default:'' }}"
                       placeholder="+593 99 999 9999">
            </div>
        </div>
        
        <!-- Configuration -->
        <div class="col-md-6">
            <h6 class="text-muted mb-3">Configuración</h6>
            
            <div class="mb-3">
                <label for="address" class="form-label">Dirección <span class="text-danger">*</span></label>
                <textarea class="form-control" id="address" name="address" rows="3" required>{{ company.address|default:'' }}</textarea>
                <div class="invalid-feedback">
                    La dirección es requerida.
                </div>
            </div>
            
            <div class="mb-3">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="is_active" name="is_active"
                           {% if not company or company.is_active %}checked{% endif %}>
                    <label class="form-check-label" for="is_active">
                        Empresa Activa
                    </label>
                </div>
                <div class="form-text">Las empresas inactivas no pueden emitir documentos</div>
            </div>
            
            {% if mode == 'create' %}
            <div class="alert alert-info" role="alert">
                <h6 class="alert-heading"><i class="fas fa-info-circle me-2"></i>Información importante:</h6>
                <ul class="mb-0 small">
                    <li>El RUC debe tener exactamente 13 dígitos</li>
                    <li>Para personas naturales, el RUC termina en 001</li>
                    <li>Para empresas, el RUC termina en 002 o superior</li>
                    <li>El sistema verificará si el RUC ya existe</li>
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
    
    {% if mode == 'edit' and company %}
    <hr>
    <div class="row">
        <div class="col-12">
            <h6 class="text-muted mb-3">Información Adicional</h6>
            <div class="row text-muted small">
                <div class="col-md-6">
                    <p><strong>ID:</strong> {{ company.id }}</p>
                    <p><strong>Fecha de registro:</strong> {{ company.created_at|date:"d/m/Y H:i" }}</p>
                    <p><strong>Usuarios activos:</strong> {{ company.users.count|default:0 }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Última actualización:</strong> {{ company.updated_at|date:"d/m/Y H:i"|default:"Nunca" }}</p>
                    <p><strong>Certificados:</strong> {{ company.digital_certificate.count|default:0 }}</p>
                    <p><strong>Tipo de Contribuyente:</strong> {{ company.get_tipo_contribuyente_display|default:"No especificado" }}</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <div class="modal-footer px-0 pb-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-1"></i>Cancelar
        </button>
        <button type="submit" class="btn btn-primary" id="submitBtn">
            <i class="fas fa-save me-1"></i>
            {% if mode == 'create' %}Crear Empresa{% else %}Guardar Cambios{% endif %}
        </button>
    </div>
</form>

<script>
$(document).ready(function() {
    let checkRucTimeout;
    let isRucAvailable = true;
    
    // Verificar RUC mientras el usuario escribe
    $('#ruc').on('input', function() {
        clearTimeout(checkRucTimeout);
        var ruc = $(this).val();
        var $statusIcon = $('#ruc-status');
        var $message = $('#ruc-message');
        
        // Resetear estado
        $(this).removeClass('is-valid is-invalid');
        isRucAvailable = true;
        
        if (ruc.length < 13) {
            $statusIcon.html('<i class="fas fa-question-circle text-muted"></i>');
            $message.text('Formato: 13 dígitos (faltan ' + (13 - ruc.length) + ' dígitos)');
            $message.removeClass('text-danger text-success').addClass('text-muted');
            return;
        }
        
        if (ruc.length === 13) {
            // Mostrar spinner mientras verifica
            $statusIcon.html('<i class="fas fa-spinner fa-spin text-info"></i>');
            $message.html('<span class="text-info">Verificando RUC...</span>');
            
            // Verificar después de 500ms que el usuario deje de escribir
            checkRucTimeout = setTimeout(function() {
                // Verificar formato
                if (!/^[0-9]{13}$/.test(ruc)) {
                    $('#ruc').addClass('is-invalid');
                    $statusIcon.html('<i class="fas fa-times-circle text-danger"></i>');
                    $message.html('<span class="text-danger">RUC inválido - debe contener solo números</span>');
                    isRucAvailable = false;
                    return;
                }
                
                // Verificar si ya existe (solo en modo crear)
                $.ajax({
                    url: '/api/v1/companies/check-ruc/',
                    method: 'GET',
                    data: { ruc: ruc },
                    success: function(response) {
                        if (response.exists) {
                            $('#ruc').addClass('is-invalid');
                            $statusIcon.html('<i class="fas fa-times-circle text-danger"></i>');
                            $message.html('<span class="text-danger"><strong>RUC ya registrado</strong> - Empresa: ' + response.company_name + '</span>');
                            isRucAvailable = false;
                        } else {
                            $('#ruc').addClass('is-valid');
                            $statusIcon.html('<i class="fas fa-check-circle text-success"></i>');
                            
                            // Identificar tipo de contribuyente
                            if (ruc.endsWith('001')) {
                                $message.html('<span class="text-success"><i class="fas fa-user"></i> RUC disponible - Persona Natural</span>');
                            } else {
                                $message.html('<span class="text-success"><i class="fas fa-building"></i> RUC disponible - Empresa/Sociedad</span>');
                            }
                            isRucAvailable = true;
                        }
                    },
                    error: function() {
                        // Si falla la verificación, continuar pero advertir
                        $('#ruc').addClass('is-valid');
                        $statusIcon.html('<i class="fas fa-exclamation-triangle text-warning"></i>');
                        $message.html('<span class="text-warning">No se pudo verificar disponibilidad</span>');
                        isRucAvailable = true;
                    }
                });
            }, 500);
        }
    });
    
    // Validación del formulario antes de enviar
    $('#companyForm').on('submit', function(e) {
        e.preventDefault();
        
        var form = this;
        var isValid = true;
        var errors = [];
        
        // Limpiar errores anteriores
        $('#errorContainer').empty();
        $('.form-control').removeClass('is-invalid');
        
        // Validar RUC
        var ruc = $('#ruc').val();
        if (!ruc || !/^[0-9]{13}$/.test(ruc)) {
            $('#ruc').addClass('is-invalid');
            errors.push('El RUC debe tener exactamente 13 dígitos numéricos');
            isValid = false;
        } else if (!isRucAvailable && '{{ mode }}' === 'create') {
            $('#ruc').addClass('is-invalid');
            errors.push('El RUC ingresado ya está registrado en el sistema');
            isValid = false;
        }
        
        // Validar campos requeridos
        var requiredFields = {
            'business_name': 'Razón Social',
            'trade_name': 'Nombre Comercial',
            'email': 'Email',
            'address': 'Dirección'
        };
        
        for (var fieldId in requiredFields) {
            var fieldValue = $('#' + fieldId).val();
            if (!fieldValue || fieldValue.trim() === '') {
                $('#' + fieldId).addClass('is-invalid');
                errors.push(requiredFields[fieldId] + ' es requerido');
                isValid = false;
            }
        }
        
        // Validar email
        var email = $('#email').val();
        var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (email && !emailRegex.test(email)) {
            $('#email').addClass('is-invalid');
            errors.push('El formato del email no es válido');
            isValid = false;
        }
        
        // Si hay errores, mostrarlos
        if (!isValid) {
            var errorHtml = '<div class="alert alert-danger alert-dismissible fade show" role="alert">';
            errorHtml += '<h6 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Por favor corrige los siguientes errores:</h6>';
            errorHtml += '<ul class="mb-0">';
            
            errors.forEach(function(error) {
                errorHtml += '<li>' + error + '</li>';
            });
            
            errorHtml += '</ul>';
            errorHtml += '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
            errorHtml += '</div>';
            
            $('#errorContainer').html(errorHtml);
            
            // Scroll al inicio del modal para mostrar los errores
            $('.modal-body').animate({ scrollTop: 0 }, 'fast');
            
            return false;
        }
        
        // Si todo está bien, enviar el formulario
        // Deshabilitar el botón para evitar doble envío
        $('#submitBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Guardando...');
        
        // Enviar usando AJAX para mejor manejo de errores
        $.ajax({
            url: $(form).attr('action'),
            method: 'POST',
            data: $(form).serialize(),
            success: function(response) {
                // Si la respuesta contiene el formulario con errores, mostrarlo
                if (response.includes('alert-danger') || response.includes('error')) {
                    // Reemplazar el contenido del modal con la respuesta
                    $('#companyModal .modal-body').html(response);
                    
                    // Re-ejecutar el script para el nuevo formulario
                    var script = document.createElement('script');
                    script.textContent = response.match(/<script>([\s\S]*?)<\/script>/)[1];
                    document.body.appendChild(script);
                } else if (response.includes('window.parent.location.reload()')) {
                    // Si fue exitoso, recargar
                    window.parent.location.reload();
                } else {
                    // Mostrar la respuesta tal cual
                    $('#companyModal .modal-body').html(response);
                }
            },
            error: function(xhr, status, error) {
                var errorMsg = 'Error al procesar la solicitud';
                
                try {
                    var responseJSON = JSON.parse(xhr.responseText);
                    if (responseJSON.error) {
                        errorMsg = responseJSON.error;
                    }
                } catch(e) {
                    if (xhr.status === 500) {
                        errorMsg = 'Error interno del servidor. Por favor, contacta al administrador.';
                    } else if (xhr.status === 404) {
                        errorMsg = 'Recurso no encontrado. La URL podría ser incorrecta.';
                    } else if (xhr.responseText) {
                        // Buscar mensajes de error en el HTML
                        var match = xhr.responseText.match(/Exception.*?:\s*(.*?)(?:<|$)/);
                        if (match) {
                            errorMsg = match[1];
                        }
                    }
                }
                
                var errorHtml = '<div class="alert alert-danger alert-dismissible fade show" role="alert">';
                errorHtml += '<h6 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Error del servidor:</h6>';
                errorHtml += '<p>' + errorMsg + '</p>';
                errorHtml += '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
                errorHtml += '</div>';
                
                $('#errorContainer').html(errorHtml);
                $('.modal-body').animate({ scrollTop: 0 }, 'fast');
                
                // Re-habilitar el botón
                $('#submitBtn').prop('disabled', false).html('<i class="fas fa-save me-1"></i>' + ('{{ mode }}' === 'create' ? 'Crear Empresa' : 'Guardar Cambios'));
            }
        });
    });
    
    // Trigger verificación inicial si hay RUC
    if ($('#ruc').val()) {
        $('#ruc').trigger('input');
    }
});
</script>